---
- hosts: eseries_beegfs_hosts
  collections:
    - netapp_eseries.host
  any_errors_fatal: true
  become: true
  tasks:
    - name: Run initial setup tasks needed to deploy new CI nodes (when run_initial_setup_tasks = True).
      block:
      - name: Execute prerequisite tasks on RHEL nodes.
        block:
          - name: Setup repomirror on RHEL.
            template:
              src: templates/rhel7_repo_mirror.j2
              dest: "/etc/yum.repos.d/ict.repo"
          - name: Install required InfiniBand packages.
            yum:
              name:
                - infiniband-diags
                - rdma-core
          - name: Ensure InfiniBand modules are loaded. #DEVNOTE: This is a workaround due to observed functionality where RHEL doesn't load the modules until after a reboot.
            modprobe:
              name: "{{ item }}"
            loop:
              - mlx5_core
              - mlx5_ib
        when: ansible_facts['os_family'] | lower == 'redhat'

      - name: Execute prerequisite tasks on SUSE nodes.
        block:
          - name: Setup repomirror on SUSE.
            template:
              src: templates/sles12_repo_mirror.j2
              dest: "/etc/zypp/repos.d/SLES12-SP4-12.4-0.repo"
          - name: Install required InfiniBand packages.
            zypper:
              name:
                - infiniband-diags
                - rdma-core
          - name: Disable SuSEfirewall2.service on SUSE nodes.
            systemd:
              name: SuSEfirewall2.service
              state: stopped
              enabled: no
        when: ansible_facts['os_family'] | lower == 'suse'

      - name: Execute prerequisite tasks on Ubuntu/Debian nodes.
        block:
         - name: Setup repomirror on Ubuntu/Debian.
           template:
             src: templates/ubuntu1804_repo_mirror.j2
             dest: "/etc/apt/sources.list"
         - name: Install required InfiniBand packages.
           apt:
             update_cache: true
             name:
               - infiniband-diags
               - rdma-core
        when: ansible_facts['os_family'] | lower == 'debian'
      when: ci_run_initial_setup_tasks == True

    - name: Import nar_santricity_multipath role.
      import_role:
        name: nar_santricity_multipath
      when: ci_run_initial_setup_tasks == True

    - name: Import nar_santricity_ipoib role.
      import_role:
        name: nar_santricity_ipoib
      when: ci_run_initial_setup_tasks == True

    - name: Import nar_santricity_iser role.
      import_role:
        name: nar_santricity_iser
      when: "ci_role == 'beegfs_server' and ci_run_initial_setup_tasks == True"

- hosts: eseries_storage_systems
  any_errors_fatal: true
  gather_facts: false
  collections:
    - netapp_eseries.santricity
  tasks:
    - name: Import nar_santricity_host role.
      import_role:
        name: nar_santricity_host
      when: ci_run_initial_setup_tasks == True